name: Security Scan (Snyk ‚Üí S3)

on:
  push:
    branches:
      - main
      - dev
      - staging
  pull_request:
    branches:
      - main
      - dev
      - staging
  workflow_dispatch:

permissions:
  contents: read

jobs:
  snyk-scan:
    name: Snyk Security Scan
    runs-on: ubuntu-latest
    continue-on-error: true

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Install Snyk CLI
        run: npm install -g snyk

      - name: Install backend dependencies
        working-directory: ./igad-app/backend
        run: |
          pip install -r requirements.txt

      - name: Install frontend dependencies
        working-directory: ./igad-app/frontend
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      - name: Run Snyk test - Backend (JSON report)
        id: snyk-backend-json
        working-directory: ./igad-app/backend
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          OUTPUT_FILE="${GITHUB_WORKSPACE}/snyk-backend.json"
          snyk test --json-file-output="${OUTPUT_FILE}" --file=requirements.txt || true
          
          if [ -f "${OUTPUT_FILE}" ]; then
            echo "report_exists=true" >> $GITHUB_OUTPUT
            echo "Snyk backend scan completed"
          else
            echo "report_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Run Snyk test - Backend (SARIF report)
        id: snyk-backend-sarif
        working-directory: ./igad-app/backend
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          OUTPUT_FILE="${GITHUB_WORKSPACE}/snyk-backend.sarif"
          snyk test --sarif-file-output="${OUTPUT_FILE}" --file=requirements.txt || true
          
          if [ -f "${OUTPUT_FILE}" ]; then
            echo "sarif_exists=true" >> $GITHUB_OUTPUT
          else
            echo "sarif_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Run Snyk test - Frontend (JSON report)
        id: snyk-frontend-json
        working-directory: ./igad-app/frontend
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          OUTPUT_FILE="${GITHUB_WORKSPACE}/snyk-frontend.json"
          snyk test --json-file-output="${OUTPUT_FILE}" --file=package.json || true
          
          if [ -f "${OUTPUT_FILE}" ]; then
            echo "report_exists=true" >> $GITHUB_OUTPUT
            echo "Snyk frontend scan completed"
          else
            echo "report_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Run Snyk test - Frontend (SARIF report)
        id: snyk-frontend-sarif
        working-directory: ./igad-app/frontend
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          OUTPUT_FILE="${GITHUB_WORKSPACE}/snyk-frontend.sarif"
          snyk test --sarif-file-output="${OUTPUT_FILE}" --file=package.json || true
          
          if [ -f "${OUTPUT_FILE}" ]; then
            echo "sarif_exists=true" >> $GITHUB_OUTPUT
          else
            echo "sarif_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Configure AWS credentials
        if: always() && !cancelled()
        env:
          AWS_SECURITY_ACCESS_KEY_ID: ${{ secrets.AWS_SECURITY_ACCESS_KEY_ID }}
          AWS_SECURITY_SECRET_ACCESS: ${{ secrets.AWS_SECURITY_SECRET_ACCESS }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
        run: |
          aws configure set aws_access_key_id "$AWS_SECURITY_ACCESS_KEY_ID"
          aws configure set aws_secret_access_key "$AWS_SECURITY_SECRET_ACCESS"
          aws configure set region "$AWS_REGION"
          aws configure set output json

      - name: Upload reports to S3
        id: upload-s3
        if: always() && !cancelled()
        env:
          AWS_SECURITY_ACCESS_KEY_ID: ${{ secrets.AWS_SECURITY_ACCESS_KEY_ID }}
          AWS_SECURITY_SECRET_ACCESS: ${{ secrets.AWS_SECURITY_SECRET_ACCESS }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
          S3_BUCKET: ${{ secrets.S3_BUCKET || 'ibd-snyk-security-reports' }}
          S3_PREFIX: ${{ secrets.S3_PREFIX || 'ibd-snyk-reports' }}
        run: |
          REPO_NAME="${{ github.repository }}"
          BRANCH_NAME="${{ github.head_ref || github.ref_name }}"
          TIMESTAMP=$(date -u +"%Y%m%d-%H%M%S")
          RUN_ID="${{ github.run_id }}"
          BRANCH_NAME_SANITIZED=$(echo "$BRANCH_NAME" | tr '/' '-')
          S3_BASE_PREFIX="${S3_PREFIX}/${REPO_NAME}/${BRANCH_NAME_SANITIZED}/${TIMESTAMP}-${RUN_ID}"
          
          UPLOADED_FILES=""
          echo "backend_json_key=" >> $GITHUB_OUTPUT
          echo "backend_sarif_key=" >> $GITHUB_OUTPUT
          echo "frontend_json_key=" >> $GITHUB_OUTPUT
          echo "frontend_sarif_key=" >> $GITHUB_OUTPUT
          
          upload_file() {
            LOCAL_FILE="$1"
            S3_KEY="$2"
            FILE_NAME="$3"
            
            if [ ! -f "$LOCAL_FILE" ]; then
              return 1
            fi
            
            if aws s3 cp "$LOCAL_FILE" "s3://${S3_BUCKET}/${S3_KEY}" --content-type "application/json" >/dev/null 2>&1; then
              return 0
            else
              return 1
            fi
          }
          
          BACKEND_JSON_FILE="${GITHUB_WORKSPACE}/snyk-backend.json"
          if [ -f "${BACKEND_JSON_FILE}" ]; then
            BACKEND_JSON_KEY="${S3_BASE_PREFIX}/backend/snyk-backend.json"
            if upload_file "${BACKEND_JSON_FILE}" "${BACKEND_JSON_KEY}" "Backend JSON"; then
              echo "backend_json_key=${BACKEND_JSON_KEY}" >> $GITHUB_OUTPUT
              UPLOADED_FILES="${UPLOADED_FILES}Backend JSON, "
            fi
          fi
          
          BACKEND_SARIF_FILE="${GITHUB_WORKSPACE}/snyk-backend.sarif"
          if [ -f "${BACKEND_SARIF_FILE}" ]; then
            BACKEND_SARIF_KEY="${S3_BASE_PREFIX}/backend/snyk-backend.sarif"
            if upload_file "${BACKEND_SARIF_FILE}" "${BACKEND_SARIF_KEY}" "Backend SARIF"; then
              echo "backend_sarif_key=${BACKEND_SARIF_KEY}" >> $GITHUB_OUTPUT
              UPLOADED_FILES="${UPLOADED_FILES}Backend SARIF, "
            fi
          fi
          
          FRONTEND_JSON_FILE="${GITHUB_WORKSPACE}/snyk-frontend.json"
          if [ -f "${FRONTEND_JSON_FILE}" ]; then
            FRONTEND_JSON_KEY="${S3_BASE_PREFIX}/frontend/snyk-frontend.json"
            if upload_file "${FRONTEND_JSON_FILE}" "${FRONTEND_JSON_KEY}" "Frontend JSON"; then
              echo "frontend_json_key=${FRONTEND_JSON_KEY}" >> $GITHUB_OUTPUT
              UPLOADED_FILES="${UPLOADED_FILES}Frontend JSON, "
            fi
          fi
          
          FRONTEND_SARIF_FILE="${GITHUB_WORKSPACE}/snyk-frontend.sarif"
          if [ -f "${FRONTEND_SARIF_FILE}" ]; then
            FRONTEND_SARIF_KEY="${S3_BASE_PREFIX}/frontend/snyk-frontend.sarif"
            if upload_file "${FRONTEND_SARIF_FILE}" "${FRONTEND_SARIF_KEY}" "Frontend SARIF"; then
              echo "frontend_sarif_key=${FRONTEND_SARIF_KEY}" >> $GITHUB_OUTPUT
              UPLOADED_FILES="${UPLOADED_FILES}Frontend SARIF, "
            fi
          fi
          
          echo "s3_bucket=${S3_BUCKET}" >> $GITHUB_OUTPUT
          echo "s3_base_prefix=${S3_BASE_PREFIX}" >> $GITHUB_OUTPUT
          echo "repo_name=${REPO_NAME}" >> $GITHUB_OUTPUT
          echo "branch_name=${BRANCH_NAME}" >> $GITHUB_OUTPUT
          echo "uploaded_files=${UPLOADED_FILES}" >> $GITHUB_OUTPUT
          
          if [ -n "${UPLOADED_FILES}" ]; then
            echo "Reports uploaded successfully"
          fi

      - name: Generate pre-signed S3 URLs
        id: presign-urls
        if: always() && !cancelled() && (steps.upload-s3.outputs.backend_json_key != '' || steps.upload-s3.outputs.frontend_json_key != '')
        env:
          AWS_SECURITY_ACCESS_KEY_ID: ${{ secrets.AWS_SECURITY_ACCESS_KEY_ID }}
          AWS_SECURITY_SECRET_ACCESS: ${{ secrets.AWS_SECURITY_SECRET_ACCESS }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
        run: |
          EXPIRY_SECONDS=604800
          S3_BUCKET="${{ steps.upload-s3.outputs.s3_bucket }}"
          
          if [ -n "${{ steps.upload-s3.outputs.backend_json_key }}" ]; then
            BACKEND_JSON_URL=$(aws s3 presign "s3://${S3_BUCKET}/${{ steps.upload-s3.outputs.backend_json_key }}" --expires-in ${EXPIRY_SECONDS})
            echo "backend_json_url=${BACKEND_JSON_URL}" >> $GITHUB_OUTPUT
          fi
          
          if [ -n "${{ steps.upload-s3.outputs.backend_sarif_key }}" ]; then
            BACKEND_SARIF_URL=$(aws s3 presign "s3://${S3_BUCKET}/${{ steps.upload-s3.outputs.backend_sarif_key }}" --expires-in ${EXPIRY_SECONDS})
            echo "backend_sarif_url=${BACKEND_SARIF_URL}" >> $GITHUB_OUTPUT
          fi
          
          if [ -n "${{ steps.upload-s3.outputs.frontend_json_key }}" ]; then
            FRONTEND_JSON_URL=$(aws s3 presign "s3://${S3_BUCKET}/${{ steps.upload-s3.outputs.frontend_json_key }}" --expires-in ${EXPIRY_SECONDS})
            echo "frontend_json_url=${FRONTEND_JSON_URL}" >> $GITHUB_OUTPUT
          fi
          
          if [ -n "${{ steps.upload-s3.outputs.frontend_sarif_key }}" ]; then
            FRONTEND_SARIF_URL=$(aws s3 presign "s3://${S3_BUCKET}/${{ steps.upload-s3.outputs.frontend_sarif_key }}" --expires-in ${EXPIRY_SECONDS})
            echo "frontend_sarif_url=${FRONTEND_SARIF_URL}" >> $GITHUB_OUTPUT
          fi

      - name: Send Slack notification
        if: always() && !cancelled() && steps.upload-s3.outputs.repo_name != ''
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_VULNERABILITY_WEBHOOK_URL }}
          BACKEND_JSON_URL: ${{ steps.presign-urls.outputs.backend_json_url }}
          FRONTEND_JSON_URL: ${{ steps.presign-urls.outputs.frontend_json_url }}
        run: |
          if [ -z "$SLACK_WEBHOOK_URL" ]; then
            echo "‚ö†Ô∏è Slack webhook not configured, skipping notification."
            exit 0
          fi
          
          REPO_NAME="${{ steps.upload-s3.outputs.repo_name }}"
          BRANCH_NAME="${{ steps.upload-s3.outputs.branch_name }}"
          GITHUB_RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          GITHUB_RUN_NUMBER="${{ github.run_number }}"
          UPLOADED_FILES="${{ steps.upload-s3.outputs.uploaded_files }}"
          
          # Clean up trailing comma and space from uploaded files
          UPLOADED_FILES_CLEAN=$(echo "$UPLOADED_FILES" | sed 's/, $//')
          
          # Build download links for backend and frontend reports
          BACKEND_LINK=""
          FRONTEND_LINK=""
          
          if [ -n "$BACKEND_JSON_URL" ]; then
            BACKEND_LINK="<${BACKEND_JSON_URL}|Backend Report>"
          fi
          
          if [ -n "$FRONTEND_JSON_URL" ]; then
            FRONTEND_LINK="<${FRONTEND_JSON_URL}|Frontend Report>"
          fi
          
          # Determine scan status
          if [ "${{ steps.snyk-backend-json.outputs.report_exists }}" = "true" ] || [ "${{ steps.snyk-frontend-json.outputs.report_exists }}" = "true" ]; then
            STATUS_EMOJI="‚úÖ"
            STATUS_TEXT="completed"
          else
            STATUS_EMOJI="‚ö†Ô∏è"
            STATUS_TEXT="completed with warnings"
          fi
          
          # Build Slack message payload
          PAYLOAD=$(cat <<EOF
          {
            "text": "${STATUS_EMOJI} Security scan ${STATUS_TEXT} ‚Äî ${REPO_NAME}",
            "blocks": [
              {
                "type": "header",
                "text": {
                  "type": "plain_text",
                  "text": "${STATUS_EMOJI} Snyk Security Scan ${STATUS_TEXT}"
                }
              },
              {
                "type": "section",
                "fields": [
                  {
                    "type": "mrkdwn",
                    "text": "*Repository:*\n\`${REPO_NAME}\`"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Branch:*\n\`${BRANCH_NAME}\`"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Reports Generated:*\n${UPLOADED_FILES_CLEAN}"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*GitHub Run:*\n<${GITHUB_RUN_URL}|View Run #${GITHUB_RUN_NUMBER}>"
                  }
                ]
              }
          EOF
          )
          
          # Add download links section if reports were uploaded
          if [ -n "$BACKEND_LINK" ] || [ -n "$FRONTEND_LINK" ]; then
            DOWNLOAD_TEXT="*üì• Download Reports (valid for 7 days):*"
            if [ -n "$BACKEND_LINK" ]; then
              DOWNLOAD_TEXT="${DOWNLOAD_TEXT}\n‚Ä¢ Backend: ${BACKEND_LINK}"
            fi
            if [ -n "$FRONTEND_LINK" ]; then
              DOWNLOAD_TEXT="${DOWNLOAD_TEXT}\n‚Ä¢ Frontend: ${FRONTEND_LINK}"
            fi
            
            DOWNLOAD_SECTION=$(cat <<EOF
              ,
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "${DOWNLOAD_TEXT}"
                }
              }
          EOF
          )
          PAYLOAD="${PAYLOAD}${DOWNLOAD_SECTION}"
          fi
          
          # Close blocks array
          PAYLOAD="${PAYLOAD}]}"
          
          curl -s -X POST \
            -H 'Content-type: application/json' \
            --data "$PAYLOAD" \
            "$SLACK_WEBHOOK_URL" >/dev/null 2>&1 || true
          
          echo "Slack notification sent"
